<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BitVault - Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js"></script>

<style>
body {
    margin: 0;
    font-family: 'Segoe UI', sans-serif;
    background: #0f172a;
    color: white;
}

.layout {
    display: flex;
    min-height: 100vh;
}

.sidebar {
    width: 220px;
    background: #111827;
    padding: 20px;
}

.sidebar h2 {
    color: #f7931a;
}

.sidebar ul {
    list-style: none;
    padding: 0;
}

.sidebar li {
    padding: 12px 0;
    cursor: pointer;
    opacity: 0.7;
}

.sidebar li:hover {
    opacity: 1;
    color: #f7931a;
}

.main-content {
    flex: 1;
    padding: 30px;
}

.top-bar {
    display: flex;
    justify-content: space-between;
    margin-bottom: 20px;
}

.premium-card {
    background: rgba(255,255,255,0.05);
    padding: 20px;
    border-radius: 16px;
    margin-bottom: 20px;
    transition: 0.4s;
}

.max-borrow-card.glow {
    box-shadow: 0 0 30px rgba(247,147,26,0.7);
}

#maxBorrowBTC {
    font-size: 28px;
    font-weight: bold;
    color: #f7931a;
}

#maxBorrowUSD {
    font-size: 18px;
    opacity: 0.8;
}
</style>
</head>
<body>

<div class="layout">
    <aside class="sidebar">
        <h2>â‚¿ BitVault</h2>
        <ul>
            <li>Dashboard</li>
            <li onclick="logout()">Logout</li>
        </ul>
    </aside>

    <main class="main-content">
        <div class="top-bar">
            <h1>Dashboard</h1>
            <div id="btcPrice">Loading BTC Price...</div>
        </div>

        <!-- MAX BORROW SECTION -->
        <div class="premium-card max-borrow-card" id="maxBorrowCard">
            <h3>You can borrow up to</h3>
            <p id="maxBorrowBTC">0 BTC</p>
            <p id="maxBorrowUSD">~ $0</p>
        </div>

        <div class="premium-card">
            <h3>Your BTC Collateral</h3>
            <p id="btcBalance">Loading...</p>
        </div>

    </main>
</div>

<script>
// ================= SUPABASE CONFIG =================
const SUPABASE_URL = "https://owulgpdukueqduvlurks.supabase.co";
const SUPABASE_KEY = "sb_publishable_2RI-unk9wI_AIEOlSUsbtA_Rwk6Tqdk";
const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_KEY);

let btcPrice = 40000;
let userBTCBalance = 0;
const platformMaxBTC = 10;

// ================= LOAD USER =================
async function loadUser() {
    const email = localStorage.getItem("currentUser");
    if (!email) return window.location.href = "index.html";

    const { data, error } = await supabaseClient
        .from("users")
        .select("*")
        .eq("email", email)
        .single();

    if (error || !data) {
        alert("User not found");
        return;
    }

    userBTCBalance = parseFloat(data.btc_balance) || 0;
    document.getElementById("btcBalance").innerText =
        userBTCBalance.toFixed(6) + " BTC";

    updateMaxBorrowDisplay();
}

// ================= BTC PRICE =================
async function fetchBTCPrice() {
    try {
        const res = await fetch(
            "https://api.coingecko.com/api/v3/simple/price?ids=bitcoin&vs_currencies=usd"
        );
        const data = await res.json();
        btcPrice = data.bitcoin.usd;
    } catch {
        btcPrice = 40000;
    }

    document.getElementById("btcPrice").innerText =
        "BTC Price: $" + btcPrice.toLocaleString();

    updateMaxBorrowDisplay();
}

setInterval(fetchBTCPrice, 30000);

// ================= MAX BORROW =================
function updateMaxBorrowDisplay() {

    const collateralLimit = userBTCBalance * 0.5;
    const finalBorrowBTC = Math.min(collateralLimit, platformMaxBTC);
    const finalBorrowUSD = finalBorrowBTC * btcPrice;

    animateNumber("maxBorrowBTC", finalBorrowBTC, 6, " BTC");
    animateCurrency("maxBorrowUSD", finalBorrowUSD);

    triggerGlow();
}

// ================= ANIMATION =================
function animateNumber(id, value, decimals, suffix) {
    const el = document.getElementById(id);
    const duration = 600;
    const startTime = performance.now();

    function update(now) {
        const progress = Math.min((now - startTime) / duration, 1);
        const current = value * progress;
        el.innerText = current.toFixed(decimals) + suffix;
        if (progress < 1) requestAnimationFrame(update);
    }

    requestAnimationFrame(update);
}

function animateCurrency(id, value) {
    const el = document.getElementById(id);
    const duration = 600;
    const startTime = performance.now();

    function update(now) {
        const progress = Math.min((now - startTime) / duration, 1);
        const current = value * progress;
        el.innerText = "~ $" + current.toLocaleString(undefined, {
            minimumFractionDigits: 2,
            maximumFractionDigits: 2
        });
        if (progress < 1) requestAnimationFrame(update);
    }

    requestAnimationFrame(update);
}

// ================= GLOW EFFECT =================
function triggerGlow() {
    const card = document.getElementById("maxBorrowCard");
    card.classList.add("glow");
    setTimeout(() => card.classList.remove("glow"), 800);
}

// ================= LOGOUT =================
function logout() {
    localStorage.removeItem("currentUser");
    window.location.href = "index.html";
}

// ================= INIT =================
loadUser();
fetchBTCPrice();
</script>

</body>
</html>
